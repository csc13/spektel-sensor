<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
<title type="text">spektel-sensor</title>
<subtitle type="text">Spektrum capacity sensor</subtitle>
<generator uri="https://github.com/mojombo/jekyll">Jekyll</generator>
<link rel="self" type="application/atom+xml" href="/feed.xml" />
<link rel="alternate" type="text/html" href="" />
<updated>2014-12-23T10:44:12+01:00</updated>
<id>/</id>
<author>
  <name>Christian</name>
  <uri>/</uri>
  <email>git@cescholz.de</email>
</author>


<entry>
  <title type="html"><![CDATA[Hardware assembly]]></title>
  <link rel="alternate" type="text/html" href="/articles/Hardware%20assembly" />
  <id>/articles/Hardware assembly</id>
  <published>2014-12-22T00:00:00+01:00</published>
  <updated>2014-12-22T00:00:00+01:00</updated>
  <author>
    <name>Christian</name>
    <uri></uri>
    <email>git@cescholz.de</email>
  </author>
  <content type="html">&lt;p&gt;After a while the REV_B PCBs arrived. So I instantly started to assemble the board. I will 
give you some insight in the process of the Surface Mount Technology (SMT) and tools I use.
Then there where some pitfalls and workarounds I will show. &lt;/p&gt;

&lt;h3 id=&quot;shrinking-the-board&quot;&gt;Shrinking the board&lt;/h3&gt;
&lt;p&gt;Remember, that I am still quite new to the surface mount devices. From REV_A to REV_B I 
changed all passive components from the 1206 to the 0603 package format. There are 
imperial (inch) and metric (mm) size form factors. Unfortunately the 0603 exists in both. In
inch it is 1.6mm long and 0.8mm wide. After some practice, I could handle this size, although the 
1206 inch size with its length of 3.2mm and width of 1.6mm is a bit easier to handle. By
mistake I ordered a few hundred metric 0603 (an imperial 0201) capacitors. These are 
0.6mm long and 0.3 mm wide. I guess it is nearly impossible to solder them reliable using
a solder iron. Find a overview on the sizes &lt;a href=&quot;http://http://en.wikipedia.org/wiki/Surface-mount_technology&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;

&lt;h3 id=&quot;the-tooling&quot;&gt;The tooling&lt;/h3&gt;
&lt;p&gt;I wanted to shrink the board and still use small and simple tools for the assembly. I don’t
have the room for a reflow oven and all that stuff.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Here is my basic toolset:&lt;/strong&gt;&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Good SMT tweezers (look for anti-magnetic, anti-static good quality)&lt;/li&gt;
  &lt;li&gt;Soldering iron with 0.8mm flat tip (I use a analog regulated 80W station)&lt;/li&gt;
  &lt;li&gt;Solder wick 1mm width&lt;/li&gt;
  &lt;li&gt;Leaded solder in 0.5mm diameter&lt;/li&gt;
  &lt;li&gt;Flux pen dispenser&lt;/li&gt;
  &lt;li&gt;Magnifying lens 15x&lt;/li&gt;
  &lt;li&gt;Clockmaker magnifying lens cap&lt;/li&gt;
  &lt;li&gt;0.4 mm tinned copper wire (mainly for the vias)&lt;/li&gt;
  &lt;li&gt;Wire cutter (not used for SMT)&lt;/li&gt;
  &lt;li&gt;Ohmmeter with connection tester&lt;/li&gt;
&lt;/ul&gt;

&lt;figure&gt;
	&lt;img src=&quot;/images/SMT_toolset.jpg&quot; /&gt;
	&lt;figcaption&gt;SMT Toolset&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;I wear the clockmaker magnifying lens with low magnification, because for soldering I don’t need
to see all the details. I flux the pads and tin one pad. The pad doesn’t need to be 
completely covered. Then I hold the SMD component with the tweezers and touch the component
pin and pad with the solder tip by putting the flat part on the pad. Because of the small
component and pad it takes only one to two seconds to see the solder flow. I use 320 to 400°C
for soldering. If one pad is a ground pad with a some connections to larger PCB areas it may
take a little longer to solder. Take your time, I didn’t burn a part up to now.&lt;/p&gt;

&lt;p&gt;Larger components like the XMEGA can be soldered the same way. Fix one pin, then another 
one on the oposite edge. After that the pins can be soldered one by one.&lt;/p&gt;

&lt;p&gt;Then I use the 15x magnifying lens with some light (holding the PCB against a lamp can help
as long as there are no big components mounted) to check for good solder and no unwanted shortcuts.
If there is a shortcut, don’t panic. Flux the area, put a fresh end of the solder wick on
the tinned part and the solder iron tip on top. The wick will soak up the solder.&lt;/p&gt;

&lt;p&gt;An Ohmmeter with a connection tester is a good companion. My multimeter has a mode, in 
which it will beep, if there is a connection. So I don’t need to look up to see if there is 
a wanted or unwanted connection. Test for the wanted connections and unwanted ones.&lt;/p&gt;

&lt;p&gt;After soldering the board I needed some time to find out unwanted connections like Ground
to Vcc and many more.&lt;/p&gt;

&lt;p&gt;A great tip I found very useful is to fix the SMD belts on a small board using double sided
duct tape. I wrote the values on the stripes. So everything is sorted and fixed.&lt;/p&gt;

&lt;h3 id=&quot;assembly-time&quot;&gt;Assembly time!&lt;/h3&gt;
&lt;p&gt;I ordered the board etched, tinned and drilled. So there are no connected vias and no 
solder or print masks. So first I removed all layers expect the routes, vias and components 
with their names in Eagle PCB to create a plan for assembling. You will find these assembly 
plans in the Github repository in the hardware REV_B folder. I printed these in A4 and 
marked the parts values by hand on it.&lt;/p&gt;

&lt;p&gt;The drill mask for the Allegro hall sensor big pins is incomplete. So I used a drill to
create the long holes needed. To connect the vias, I laid the board on a flat surface,
put 0.4mm tinned copper wire trough the holes and cut 2mm above. After 4 - 8 vias, I apply
flux and solder them. After all the other side can be soldered and the exzessive wire
cut away.&lt;/p&gt;

&lt;p&gt;Then I soldered the components on the top side (the µC side). I started with the small 
components inside out. Be aware, that diodes are polarized and get the direction right. 
The have a point or stripe on the minus pin. See the result on the next picture:&lt;/p&gt;

&lt;figure&gt;
	&lt;img src=&quot;/images/Assembled_REV_B_top.jpg&quot; /&gt;
	&lt;figcaption&gt;Assembled REV_B top side&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;p&gt;The Allegro current pins are not soldered yet.&lt;/p&gt;

&lt;p&gt;In the B revision I tried to avoid using pins as vias, since it is difficult to solder a 
pin header from its top. But it is necessary in two cases as shown in the errata later on.
The bottom side is much easier, because the two pin headers, two X-Bus connectors, the
Allegro sensor and button take almost all of the space.&lt;/p&gt;

&lt;figure&gt;
	&lt;img src=&quot;/images/Assembled_REV_B_bottom.jpg&quot; /&gt;
	&lt;figcaption&gt;Assembled REV_B bottom side&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id=&quot;errata&quot;&gt;Errata&lt;/h3&gt;
&lt;p&gt;Again, there are some small faults on the board. Or at least things to optimize. I put
the connectors on the bottom side, so that most of the soldering can be made on the top side only.
The ground pin of the X-Bus ZH connectors needs to be connected to the bottom side.
At least the angled connector can be soldered more easy than the straight one. &lt;em&gt;Make sure
to solder this before assembling the straight connector&lt;/em&gt;. If you only use this sensor,
only one connector is needed anyway.&lt;/p&gt;

&lt;p&gt;Second, the ground pin of the Serial connector needs to be connected to the bottom plate.
I used an exacto knife to remove the plastic around the pin. With lots of flux the pin then
can be soldered.&lt;/p&gt;

&lt;figure&gt;
	&lt;img src=&quot;/images/Assembled_REV_B_bottom_errata.jpg&quot; /&gt;
	&lt;figcaption&gt;Assembled REV_B bottom side&lt;/figcaption&gt;
&lt;/figure&gt;

&lt;h3 id=&quot;outlook&quot;&gt;Outlook&lt;/h3&gt;
&lt;p&gt;In future versions, a small capacitor at the Allegro signal pin can serve as a hardware 
low pass filter (thanks to Ingo on the rc-heli.de forum). Additional cell voltage measurements
would be nice as well.  &lt;/p&gt;


  &lt;p&gt;&lt;a href=&quot;/articles/Hardware%20assembly&quot;&gt;Hardware assembly&lt;/a&gt; was originally published by Christian at &lt;a href=&quot;&quot;&gt;spektel-sensor&lt;/a&gt; on December 22, 2014.&lt;/p&gt;</content>
</entry>


<entry>
  <title type="html"><![CDATA[XMEGA32E5]]></title>
  <link rel="alternate" type="text/html" href="/articles/xmega" />
  <id>/articles/xmega</id>
  <published>2014-11-26T00:00:00+01:00</published>
  <updated>2014-11-26T00:00:00+01:00</updated>
  <author>
    <name>Christian</name>
    <uri></uri>
    <email>git@cescholz.de</email>
  </author>
  <content type="html">&lt;p&gt;Some may ask, why I have chosen the XMEGA32E5 for the project. Here is why, or at least
why at the end I used it.&lt;/p&gt;

&lt;h3 id=&quot;why-the-xmega&quot;&gt;Why the XMEGA?&lt;/h3&gt;
&lt;p&gt;Arduino is a great starting point for microcontroller beginners. Its widely available, 
has boards for easy assembling, a nice IDE and libraries for abstraction. And it’s all 
open source and low priced. So I started with the ATMEGA family going to straight 
AVR GCC programming using an ATTINY. Seeing Schorsch’s project on the RC-Heli 
&lt;a href=&quot;http://www.rc-heli.de/board/showthread.php?t=190165&quot;&gt;thread&lt;/a&gt; using the XMEGA with 
some features got my attention. The upgrade from the ATMEGA shouldn’t be that difficult.&lt;/p&gt;

&lt;h3 id=&quot;atmega-vs-xmega&quot;&gt;ATMEGA vs. XMEGA&lt;/h3&gt;
&lt;p&gt;The XMEGA32E5 comes in a small TQFP package. I was looking for a SMD package, since it 
reduces the overall project footprint. It brings a 12 Bit Analog-Digital-Converter 
and a event-system. There are two I2C ports, one as an I2C Slave and one as an I2C Master. 
The slave port is used for the connection to the Spektrum-RC, the master port for the BMP180 
pressure sensor. The XMEGA has a 32MHz clock rate compared to the 16MHz of the ATMEGA328.&lt;/p&gt;

&lt;p&gt;Being quite new to micros I didn’t expect much differences. 
But there are some. First, the XMEGA uses 3.3V and can not be operated using 5V. 
So all components should work with 3.3V too. Next the XMEGA uses PDI instead of ISP for 
programming the device. So I needed a dedicated programmer, since the Bootloader/USB 
method of the Arduino doesn’t work. I used the Arduino as an ISP for the ATTINY, which 
doesn’t work as well. Eventually I got a small cheap AVRISP clone based on an Atmel 
chip. But the Jungo USB drivers are not compatible to the Mac. So I switched to Windows, the 
Atmel AVR Studio and the ASF a development framework. To test this it is handy to have 
a XMEGA breakout board for testing.&lt;/p&gt;

&lt;h3 id=&quot;some-words-on-developing-on-mac-osx&quot;&gt;Some words on developing on Mac OsX&lt;/h3&gt;
&lt;p&gt;Using a Mac is no problem in most cases. A lot of Linux software is easily usable. There is
a AVR GCC toolchain and avrdude version at the Atmel website. Using a 
programmer with the FTDI USB chip (like the Arduinos use) is also no problem. 
But both, the cheap AVR ISP mkII clone as well as an Atmel JTAG ICE mkII didn’t work with
Mac OsX, since there is no Mac driver for the used Atmel USB chip. And I couldn’t get the
libusb running. At the end I switched to Windows 8.1 in a Parallels VM. With this I
use the AVR Studio 6.x. This is not that fast on my Mac Book Air (2010), but works.
I like the GCC toolchain, because it’s lightweight, but the AVR Studio is much more easy to use.&lt;/p&gt;

&lt;h3 id=&quot;using-the-atmel-avr-studio-and-asf&quot;&gt;Using the Atmel AVR Studio and ASF&lt;/h3&gt;
&lt;p&gt;The AVR Studio and ASF makes it easy to setup the device specific parts of a project.
Just select the microcontroller and modules (like ADC, Timer, etc.) used 
in the project, the programming tool and board if using a standard Atmel board.
The IDE and ASF takes care of including the required libraries and tools. 
The ASF works, but not always as expected. Maybe I will write on this later on.&lt;/p&gt;

&lt;h3 id=&quot;conclusion&quot;&gt;Conclusion&lt;/h3&gt;
&lt;p&gt;The change from the ATMEGA to XMEGA was quite painful, since I changed the complete development
tool chain. This was the case, since I use a Mac and the programmer hardware does not supporte Mac OsX.&lt;/p&gt;

&lt;p&gt;Beside this it is quite different to program using Arduino, the Atmel AFS or pure C. I didn’t
test the XMEGA Arduino port, but I will keep using Arduino for fast prototyping with the
ATMEGA. At the moment I will stay with the AVR Studio and AFS for the more complex projects.&lt;/p&gt;


  &lt;p&gt;&lt;a href=&quot;/articles/xmega&quot;&gt;XMEGA32E5&lt;/a&gt; was originally published by Christian at &lt;a href=&quot;&quot;&gt;spektel-sensor&lt;/a&gt; on November 26, 2014.&lt;/p&gt;</content>
</entry>


<entry>
  <title type="html"><![CDATA[New Revision_B board ready]]></title>
  <link rel="alternate" type="text/html" href="/articles/new_rev_b" />
  <id>/articles/new_rev_b</id>
  <published>2014-11-23T00:00:00+01:00</published>
  <updated>2014-11-23T00:00:00+01:00</updated>
  <author>
    <name>Christian</name>
    <uri></uri>
    <email>git@cescholz.de</email>
  </author>
  <content type="html">&lt;p&gt;The &lt;code&gt;REV_A&lt;/code&gt; sensor worked and the last capacity measurements were within 3% of the loaded capacity.
So thinks were working fine. But the REV_A board had a major bug on the footprint of the
BMP180 pressure sensor I want to use for the Vario and Altimeter functions. So I tried to 
fix it with the solder iron. At the end I bricked it. One of the PDI lines goes under the
microcontroller and this was the one having a short connection to the ground.&lt;/p&gt;

&lt;p&gt;Since I proved everything possible with &lt;code&gt;REV_A&lt;/code&gt; I went on and designed &lt;code&gt;REV_B&lt;/code&gt;. It’s on
&lt;a href=&quot;https://github.com/csc13/spektel-sensor/tree/master/hardware/REV_B&quot;&gt;GitHub&lt;/a&gt; right now.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;&lt;em&gt;NOTE: The REV_B is not yet tested. So I don’t know if it works!&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;

&lt;h3 id=&quot;news-in-revb&quot;&gt;News in REV_B&lt;/h3&gt;

&lt;p&gt;There are some new features:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;A button for programming&lt;/li&gt;
  &lt;li&gt;A voltage reverence of 2048mV to the AREF pin of the XMEGA&lt;/li&gt;
  &lt;li&gt;Some &lt;strong&gt;Ferrite Chip Beads&lt;/strong&gt; and some small capacities at the IC VCC pins for steady working power&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;And it has a much smaller footprint of a board size under 35x35mm! So most components have
the 0603 SMD package. This will be a challenge for the soldering I plan to do by hand.&lt;/p&gt;


  &lt;p&gt;&lt;a href=&quot;/articles/new_rev_b&quot;&gt;New Revision_B board ready&lt;/a&gt; was originally published by Christian at &lt;a href=&quot;&quot;&gt;spektel-sensor&lt;/a&gt; on November 23, 2014.&lt;/p&gt;</content>
</entry>


<entry>
  <title type="html"><![CDATA[Adding Processing support]]></title>
  <link rel="alternate" type="text/html" href="/articles/Adding_Processing_Support" />
  <id>/articles/Adding_Processing_Support</id>
  <published>2014-11-02T00:00:00+01:00</published>
  <updated>2014-11-02T00:00:00+01:00</updated>
  <author>
    <name>Christian</name>
    <uri></uri>
    <email>git@cescholz.de</email>
  </author>
  <content type="html">&lt;h4 id=&quot;added-support-for-realtimeplotter-and-arduplot&quot;&gt;2014-11-02: Added support for RealtimePlotter and arduplot&lt;/h4&gt;
&lt;p&gt;I learned, that the main part on building a sensor is the software to grind and polish the
signals read from the hardware sensor. In this case it was the Allegro ACS758LCB-100U hall 
effect current sensor.&lt;/p&gt;

&lt;p&gt;So I read about digital filtering and use 3 cascaded the &lt;code&gt;Moving Average&lt;/code&gt; algorithm to smooth the
sensor reading.&lt;/p&gt;

&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot; data-lang=&quot;html&quot;&gt;&lt;span class=&quot;lineno&quot;&gt;1&lt;/span&gt; //filter use in main.c
&lt;span class=&quot;lineno&quot;&gt;2&lt;/span&gt; AddToFloatAvg(&lt;span class=&quot;err&quot;&gt;&amp;amp;&lt;/span&gt;cur_filter1, (cur_mea_val));
&lt;span class=&quot;lineno&quot;&gt;3&lt;/span&gt; AddToFloatAvg(&lt;span class=&quot;err&quot;&gt;&amp;amp;&lt;/span&gt;cur_filter2, GetOutputValue(&lt;span class=&quot;ni&quot;&gt;&amp;amp;cur_filter1));&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;4&lt;/span&gt; AddToFloatAvg(&lt;span class=&quot;err&quot;&gt;&amp;amp;&lt;/span&gt;cur_filter3, GetOutputValue(&lt;span class=&quot;ni&quot;&gt;&amp;amp;cur_filter2));&lt;/span&gt;
&lt;span class=&quot;lineno&quot;&gt;5&lt;/span&gt; cur_adc_res[act] = (GetOutputValue(&lt;span class=&quot;ni&quot;&gt;&amp;amp;cur_filter3));&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Each filter has 9 readings. For details see &lt;code&gt;src/floating_average.h&lt;/code&gt; and &lt;code&gt;.c&lt;/code&gt; files.&lt;/p&gt;

&lt;p&gt;By testing I used the DX9 transmitter, recorded to the SD card and read that using the TLM Reader.
This was a long procedure. Since I already put a header with the Rx, Tx serial pins on the
board it shouldn’t be that much of a problem to show some output on the Mac using the Processing
tools.&lt;/p&gt;

&lt;p&gt;I found two great serial monitors based on &lt;a href=&quot;https://www.processing.org/&quot;&gt;Processing&lt;/a&gt;.
Please see the &lt;a href=&quot;https://github.com/sebnil/RealtimePlotter.git&quot;&gt;RealtimePlotter&lt;/a&gt; and 
&lt;a href=&quot;https://github.com/dahart/arduplot.git&quot;&gt;Arduplot&lt;/a&gt;. Thanks to their contributors. Just uncomment
the lines in the &lt;code&gt;config/conf_board.h&lt;/code&gt; file.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;/articles/Adding_Processing_Support&quot;&gt;Adding Processing support&lt;/a&gt; was originally published by Christian at &lt;a href=&quot;&quot;&gt;spektel-sensor&lt;/a&gt; on November 02, 2014.&lt;/p&gt;</content>
</entry>


<entry>
  <title type="html"><![CDATA[First test flight]]></title>
  <link rel="alternate" type="text/html" href="/articles/test-flight-log" />
  <id>/articles/test-flight-log</id>
  <published>2014-10-29T00:00:00+01:00</published>
  <updated>2014-10-29T00:00:00+01:00</updated>
  <author>
    <name>Christian</name>
    <uri></uri>
    <email>git@cescholz.de</email>
  </author>
  <content type="html">&lt;p&gt;This was one of the first flights using the sensor in it’s target environment, the T-REX 500 RC
heli. I did a lot of bench testing using a light bulb up to 3A. But nor the bulb or the power
supply could have done much more. So this was the first test with more Amps.&lt;/p&gt;

&lt;p&gt;I’m using a Spektrum DX9 transmitter with SD card slot. I use the TLM Reader. Here is the result:&lt;/p&gt;

&lt;figure&gt;
	&lt;img src=&quot;/images/TREX500_20141026_REVA.png&quot; /&gt;
	&lt;figcaption&gt;T-REX 500 flight log&lt;/figcaption&gt;
&lt;/figure&gt;

  &lt;p&gt;&lt;a href=&quot;/articles/test-flight-log&quot;&gt;First test flight&lt;/a&gt; was originally published by Christian at &lt;a href=&quot;&quot;&gt;spektel-sensor&lt;/a&gt; on October 29, 2014.&lt;/p&gt;</content>
</entry>


<entry>
  <title type="html"><![CDATA[Initial Upload]]></title>
  <link rel="alternate" type="text/html" href="/Initial%20upload" />
  <id>/Initial upload</id>
  <published>2014-10-28T00:00:00+01:00</published>
  <updated>2014-10-28T00:00:00+01:00</updated>
  <author>
    <name>Christian</name>
    <uri></uri>
    <email>git@cescholz.de</email>
  </author>
  <content type="html">&lt;p&gt;The prototype of the spektel-sensor passed its first successful tests. The revision A layout
and corresponding code is up on &lt;a href=&quot;https://github.com/csc13/spektel-sensor.git&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Please be aware, that &lt;code&gt;REV_A&lt;/code&gt; had several faults on the board. So the Bosch BMP180 sensor
won’t work, because I didn’t read the datasheet correctly.&lt;/p&gt;

&lt;p&gt;After learning Eagle PCB, a software I can recommend to everybody, I spend some nights to
find the Eagle libraries for the parts I wanted to use and create the layout. At the end
I was little impatient to order the PCB (printed circuite board) at a board manufacturer.
I chose a little one, who did a great job etching and drilling the board.&lt;/p&gt;

&lt;p&gt;But I found several bugs in the layout. So I used a exacto hobby knife, some lacquered copper
wire and fixed it. As a mostly software guy I had to learn that a hardware bug can’t be fixed that
fast. And ordering a new board takes some days and money. so in the future I will print the board
layout on paper and go through all components and wires.&lt;/p&gt;

  &lt;p&gt;&lt;a href=&quot;/Initial%20upload&quot;&gt;Initial Upload&lt;/a&gt; was originally published by Christian at &lt;a href=&quot;&quot;&gt;spektel-sensor&lt;/a&gt; on October 28, 2014.&lt;/p&gt;</content>
</entry>

</feed>